{% extends "base.html" %}
{% load static %}

{% block title %}Location Tracker - Rita AI Suite{% endblock %}

{% block extra_css %}
    <style>
        /* Ghi đè các quy tắc có thể gây xung đột để trả lại thanh cuộn chính */
        html, body {
            height: auto;
            overflow-x: hidden;
            overflow-y: auto;
        }
        .app-container, .main-content {
            height: auto !important;
            overflow: visible !important;
        }
        body::-webkit-scrollbar { width: 10px; }
        body::-webkit-scrollbar-track { background: #1a1a2e; }
        body::-webkit-scrollbar-thumb { background-color: #4a4a6a; border-radius: 10px; border: 2px solid #1a1a2e; }
        body::-webkit-scrollbar-thumb:hover { background-color: #68d391; }

        /* --- GIAO DIỆN MỚI --- */
        .tracker-container {
            max-width: 1100px;
            margin: 2rem auto;
            padding: 1rem;
        }

        .tracker-title-wrapper {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1rem;
            margin-bottom: 2.5rem;
        }

        .tracker-title {
            font-size: 2.8rem;
            font-weight: 700;
            text-align: center;
            margin: 0;
            color: #e0e0e0;
        }

        /* --- Nút và Modal Hướng dẫn --- */
        .help-btn {
            background-color: #3a3a5a;
            color: #e0e0e0;
            border: none;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            font-size: 1.2rem;
            cursor: pointer;
            transition: background-color 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .help-btn:hover {
            background-color: #4a4a6a;
        }
        .help-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }
        .help-modal-overlay.visible {
            opacity: 1;
            visibility: visible;
        }
        .help-modal-card {
            background: #1e1e2e;
            border: 1px solid #3a3a5a;
            border-radius: 16px;
            padding: 2rem;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            position: relative;
        }
        .help-modal-card h3 {
            font-size: 1.5rem;
            font-weight: 600;
            color: #fff;
            margin-bottom: 1.5rem;
        }
        .help-modal-card p {
            color: #a0a0d0;
            line-height: 1.6;
            margin-bottom: 1rem;
        }
        .help-modal-card strong {
            color: #68d391;
        }
        .help-modal-close-btn {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            color: #a0a0d0;
            font-size: 1.5rem;
            cursor: pointer;
        }

        .tracker-card {
            background: rgba(30, 30, 46, 0.7);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 2rem;
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            margin-bottom: 2.5rem;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        }

        .card-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
            color: #fff;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .create-link-form {
            display: flex;
            gap: 1rem;
        }
        .create-link-form input[type="url"] {
            flex-grow: 1;
            padding: 0.85rem 1.25rem;
            background-color: #1e1e2e;
            border: 1px solid #3a3a5a;
            border-radius: 8px;
            color: #e0e0e0;
            font-size: 1rem;
            transition: border-color 0.3s, box-shadow 0.3s;
        }
        .create-link-form input[type="url"]:focus {
            outline: none;
            border-color: #68d391;
            box-shadow: 0 0 0 3px rgba(104, 211, 145, 0.2);
        }
        .create-link-form button {
            padding: 0.85rem 1.75rem;
            background: linear-gradient(90deg, #68d391, #34d399);
            color: #1a1a2e;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        .create-link-form button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(104, 211, 145, 0.3);
        }

        .history-item {
            background-color: #1e1e2e;
            padding: 1.5rem;
            border-radius: 12px;
            margin-bottom: 1.5rem;
            border: 1px solid #3a3a5a;
        }
        .history-item:last-child {
            margin-bottom: 0;
        }
        .info-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }
        .info-text {
            font-size: 0.85rem;
            color: #a0a0d0;
        }
        .delete-btn {
            background: none;
            border: 1px solid #e53e3e;
            color: #e53e3e;
            padding: 0.3rem 0.7rem;
            font-size: 0.8rem;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.2s, color 0.2s;
        }
        .delete-btn:hover {
            background-color: #e53e3e;
            color: #fff;
        }
        .link-display {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
            background-color: #12121c;
            padding: 0.75rem 1rem;
            border-radius: 8px;
            margin-top: 0.75rem;
        }
        .link-text {
            word-break: break-all;
            color: #e0e0e0;
            font-size: 0.9rem;
        }
        .link-text strong {
            color: #a0a0d0;
        }
        .copy-btn {
            padding: 0.4rem 0.8rem;
            background-color: #3a3a5a;
            color: #e0e0e0;
            border: none;
            border-radius: 6px;
            font-size: 0.8rem;
            cursor: pointer;
            flex-shrink: 0;
            transition: background-color 0.2s;
        }
        .copy-btn:hover {
            background-color: #4a4a6a;
        }

        .logs-table-wrapper {
            max-height: 220px;
            overflow-y: auto;
            border: 1px solid #3a3a5a;
            border-radius: 8px;
            margin-top: 1rem;
        }
        .logs-table-wrapper::-webkit-scrollbar { width: 6px; }
        .logs-table-wrapper::-webkit-scrollbar-track { background: transparent; }
        .logs-table-wrapper::-webkit-scrollbar-thumb { background-color: #4a4a6a; border-radius: 6px; }
        
        .logs-table {
            width: 100%;
            font-size: 0.9rem;
        }
        .logs-table th, .logs-table td {
            padding: 0.85rem 1.25rem;
            text-align: left;
        }
        .logs-table thead {
            background-color: rgba(42, 42, 62, 0.8);
            color: #a0a0d0;
            position: sticky;
            top: 0;
        }
        .logs-table tbody tr {
            border-bottom: 1px solid #3a3a5a;
        }
        .logs-table tbody tr:last-child {
            border-bottom: none;
        }
        .logs-table a {
            color: #68d391;
            text-decoration: none;
            font-weight: 500;
        }
        .logs-table a:hover {
            text-decoration: underline;
        }
    </style>
{% endblock %}

{% block content %}
<div class="tracker-container">
    <div class="tracker-title-wrapper">
        <h1 class="tracker-title">Công cụ Theo dõi Vị trí</h1>
        <button id="help-btn" class="help-btn" aria-label="Hướng dẫn">?</button>
    </div>
    
    <div class="tracker-card">
        <h2 class="card-title">Tạo Link Mới</h2>
        <form method="POST" action="" class="create-link-form">
            {% csrf_token %}
            <input type="url" name="url" placeholder="Dán đường dẫn gốc vào đây..." required>
            <button type="submit">Tạo Link</button>
        </form>
    </div>

    <div class="tracker-card">
        <h2 class="card-title">Lịch sử Links</h2>
        <div class="history-list">
            {% for link in links %}
            <div class="history-item" id="history-item-{{ link.id }}">
                <div class="info-header">
                    <p class="info-text">Tạo lúc: {{ link.created_at|date:"H:i, d/m/Y" }}</p>
                    <button class="delete-btn" onclick="deleteTrackingLink({{ link.id }})">Xóa</button>
                </div>
                <div class="link-display">
                    <p class="link-text"><strong>Gốc:</strong> <a href="{{ link.original_url }}" target="_blank" class="text-blue-400 hover:underline">{{ link.original_url }}</a></p>
                </div>
                <div class="link-display">
                    <p id="link-{{ link.tracking_id }}" class="link-text"><strong>Theo dõi:</strong> <span class="text-green-400">{{ base_url }}t/{{ link.tracking_id }}/</span></p>
                    <button onclick="copyToClipboard('link-{{ link.tracking_id }}')" class="copy-btn">Copy</button>
                </div>
                
                <h3 class="font-semibold text-gray-300 mt-4 mb-2">Nhật ký Vị trí (<span class="log-count">{{ link.logs.count }}</span> lượt):</h3>
                {% if link.logs.all %}
                <div class="logs-table-wrapper">
                    <table class="logs-table">
                        <thead>
                            <tr>
                                <th>Thời gian</th>
                                <th>Vĩ độ</th>
                                <th>Kinh độ</th>
                                <th>Bản đồ</th>
                            </tr>
                        </thead>
                        <tbody id="log-table-body-{{ link.id }}">
                            {% for log in link.logs.all %}
                            <tr>
                                <td>{{ log.timestamp|date:"H:i:s, d/m/Y" }}</td>
                                <td>{{ log.latitude|floatformat:5 }}</td>
                                <td>{{ log.longitude|floatformat:5 }}</td>
                                <td><a href="https://www.google.com/maps?q={{ log.latitude }},{{ log.longitude }}" target="_blank">Xem</a></td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <p class="info-text italic no-logs-msg" style="display: none;">Chưa có lượt click nào.</p>
                {% else %}
                <div class="logs-table-wrapper" style="display: none;">
                     <table class="logs-table">
                        <thead>
                            <tr>
                                <th>Thời gian</th>
                                <th>Vĩ độ</th>
                                <th>Kinh độ</th>
                                <th>Bản đồ</th>
                            </tr>
                        </thead>
                        <tbody id="log-table-body-{{ link.id }}"></tbody>
                    </table>
                </div>
                <p class="info-text italic no-logs-msg">Chưa có lượt click nào.</p>
                {% endif %}
            </div>
            {% empty %}
            <p id="no-links-msg" class="info-text text-center">Chưa có link nào được tạo.</p>
            {% endfor %}
        </div>
    </div>
</div>

<!-- Modal Hướng dẫn -->
<div id="help-modal" class="help-modal-overlay">
    <div class="help-modal-card">
        <button id="help-modal-close-btn" class="help-modal-close-btn">&times;</button>
        <h3>Hướng dẫn sử dụng</h3>
        <p><strong>Bước 1: Tạo Link</strong><br>Dán một đường link bất kỳ vào ô "Tạo Link Mới" và nhấn nút "Tạo Link".</p>
        <p><strong>Bước 2: Gửi Link</strong><br>Sao chép "Link Theo dõi" vừa được tạo và gửi cho người bạn muốn biết vị trí.</p>
        <p><strong>Bước 3: Theo dõi</strong><br>Khi người nhận nhấp vào link, vị trí của họ <strong>(nếu được cho phép)</strong> sẽ được ghi lại và hiển thị trong bảng "Nhật ký Vị trí". Bảng sẽ tự động cập nhật sau mỗi 5 giây.</p>
    </div>
</div>

<footer class="site-footer"> <p>Copyright © 2025 Lequyphat</p> </footer>
{% endblock %}

{% block extra_js %}
<script>
    // --- Các hàm hiện có (getCookie, copyToClipboard, deleteTrackingLink, updateDashboard, fetchTrackerData) ---
    function getCookie(name) { /* ... */ }
    function copyToClipboard(elementId) { /* ... */ }
    async function deleteTrackingLink(linkId) { /* ... */ }
    function updateDashboard(linksData) { /* ... */ }
    async function fetchTrackerData() { /* ... */ }
    
    // Tự động làm mới mỗi 5 giây
    setInterval(fetchTrackerData, 5000);

    // --- LOGIC MỚI CHO MODAL HƯỚNG DẪN ---
    const helpBtn = document.getElementById('help-btn');
    const helpModal = document.getElementById('help-modal');
    const closeModalBtn = document.getElementById('help-modal-close-btn');

    if (helpBtn && helpModal && closeModalBtn) {
        helpBtn.addEventListener('click', () => {
            helpModal.classList.add('visible');
        });

        closeModalBtn.addEventListener('click', () => {
            helpModal.classList.remove('visible');
        });

        // Đóng modal khi click ra ngoài
        helpModal.addEventListener('click', (event) => {
            if (event.target === helpModal) {
                helpModal.classList.remove('visible');
            }
        });
    }
</script>
{% endblock %}
