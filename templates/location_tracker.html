{% extends "base.html" %}
{% load static %}

{% block title %}Location Tracker - Rita AI Suite{% endblock %}

{% block extra_css %}
    <style>
        /* Ghi đè các quy tắc có thể gây xung đột để trả lại thanh cuộn chính */
        html, body {
            height: auto;
            overflow-x: hidden;
            overflow-y: auto;
        }
        .app-container, .main-content {
            height: auto !important;
            overflow: visible !important;
        }
        body::-webkit-scrollbar { width: 10px; }
        body::-webkit-scrollbar-track { background: #1a1a2e; }
        body::-webkit-scrollbar-thumb { background-color: #4a4a6a; border-radius: 10px; border: 2px solid #1a1a2e; }
        body::-webkit-scrollbar-thumb:hover { background-color: #68d391; }

        /* --- GIAO DIỆN MỚI --- */
        .tracker-container {
            max-width: 1100px;
            margin: 2rem auto;
            padding: 1rem;
        }

        .tracker-title {
            font-size: 2.8rem;
            font-weight: 700;
            text-align: center;
            margin-bottom: 2.5rem;
            color: #e0e0e0;
        }

        .tracker-card {
            background: rgba(30, 30, 46, 0.7);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 2rem;
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            margin-bottom: 2.5rem;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        }

        .card-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
            color: #fff;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .create-link-form {
            display: flex;
            gap: 1rem;
        }
        .create-link-form input[type="url"] {
            flex-grow: 1;
            padding: 0.85rem 1.25rem;
            background-color: #1e1e2e;
            border: 1px solid #3a3a5a;
            border-radius: 8px;
            color: #e0e0e0;
            font-size: 1rem;
            transition: border-color 0.3s, box-shadow 0.3s;
        }
        .create-link-form input[type="url"]:focus {
            outline: none;
            border-color: #68d391;
            box-shadow: 0 0 0 3px rgba(104, 211, 145, 0.2);
        }
        .create-link-form button {
            padding: 0.85rem 1.75rem;
            background: linear-gradient(90deg, #68d391, #34d399);
            color: #1a1a2e;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        .create-link-form button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(104, 211, 145, 0.3);
        }

        .history-item {
            background-color: #1e1e2e;
            padding: 1.5rem;
            border-radius: 12px;
            margin-bottom: 1.5rem;
            border: 1px solid #3a3a5a;
        }
        .history-item:last-child {
            margin-bottom: 0;
        }
        .info-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }
        .info-text {
            font-size: 0.85rem;
            color: #a0a0d0;
        }
        .delete-btn {
            background: none;
            border: 1px solid #e53e3e;
            color: #e53e3e;
            padding: 0.3rem 0.7rem;
            font-size: 0.8rem;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.2s, color 0.2s;
        }
        .delete-btn:hover {
            background-color: #e53e3e;
            color: #fff;
        }
        .link-display {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
            background-color: #12121c;
            padding: 0.75rem 1rem;
            border-radius: 8px;
            margin-top: 0.75rem;
        }
        .link-text {
            word-break: break-all;
            color: #e0e0e0;
            font-size: 0.9rem;
        }
        .link-text strong {
            color: #a0a0d0;
        }
        .copy-btn {
            padding: 0.4rem 0.8rem;
            background-color: #3a3a5a;
            color: #e0e0e0;
            border: none;
            border-radius: 6px;
            font-size: 0.8rem;
            cursor: pointer;
            flex-shrink: 0;
            transition: background-color 0.2s;
        }
        .copy-btn:hover {
            background-color: #4a4a6a;
        }

        .logs-table-wrapper {
            max-height: 220px;
            overflow-y: auto;
            border: 1px solid #3a3a5a;
            border-radius: 8px;
            margin-top: 1rem;
        }
        .logs-table-wrapper::-webkit-scrollbar { width: 6px; }
        .logs-table-wrapper::-webkit-scrollbar-track { background: transparent; }
        .logs-table-wrapper::-webkit-scrollbar-thumb { background-color: #4a4a6a; border-radius: 6px; }
        
        .logs-table {
            width: 100%;
            font-size: 0.9rem;
        }
        .logs-table th, .logs-table td {
            padding: 0.85rem 1.25rem;
            text-align: left;
        }
        .logs-table thead {
            background-color: rgba(42, 42, 62, 0.8);
            color: #a0a0d0;
            position: sticky;
            top: 0;
        }
        .logs-table tbody tr {
            border-bottom: 1px solid #3a3a5a;
        }
        .logs-table tbody tr:last-child {
            border-bottom: none;
        }
        .logs-table a {
            color: #68d391;
            text-decoration: none;
            font-weight: 500;
        }
        .logs-table a:hover {
            text-decoration: underline;
        }
    </style>
{% endblock %}

{% block content %}
<div class="tracker-container">
    <h1 class="tracker-title">Công cụ Theo dõi Vị trí</h1>
    
    <div class="tracker-card">
        <h2 class="card-title">Tạo Link Mới</h2>
        <form method="POST" action="">
            {% csrf_token %}
            <input type="url" name="url" placeholder="Dán đường dẫn gốc vào đây..." required>
            <button type="submit">Tạo Link</button>
        </form>
    </div>

    <div class="tracker-card">
        <h2 class="card-title">Lịch sử Links</h2>
        <div class="history-list">
            {% for link in links %}
            <div class="history-item" id="history-item-{{ link.id }}">
                <div class="info-header">
                    <p class="info-text">Tạo lúc: {{ link.created_at|date:"H:i, d/m/Y" }}</p>
                    <button class="delete-btn" onclick="deleteTrackingLink({{ link.id }})">Xóa</button>
                </div>
                <div class="link-display">
                    <p class="link-text"><strong>Gốc:</strong> <a href="{{ link.original_url }}" target="_blank" class="text-blue-400 hover:underline">{{ link.original_url }}</a></p>
                </div>
                <div class="link-display">
                    <p id="link-{{ link.tracking_id }}" class="link-text"><strong>Theo dõi:</strong> <span class="text-green-400">{{ base_url }}t/{{ link.tracking_id }}/</span></p>
                    <button onclick="copyToClipboard('link-{{ link.tracking_id }}')" class="copy-btn">Copy</button>
                </div>
                
                <h3 class="font-semibold text-gray-300 mt-4 mb-2">Nhật ký Vị trí (<span class="log-count">{{ link.logs.count }}</span> lượt):</h3>
                {% if link.logs.all %}
                <div class="logs-table-wrapper">
                    <table class="logs-table">
                        <thead>
                            <tr>
                                <th>Thời gian</th>
                                <th>Vĩ độ</th>
                                <th>Kinh độ</th>
                                <th>Bản đồ</th>
                            </tr>
                        </thead>
                        <tbody id="log-table-body-{{ link.id }}">
                            {% for log in link.logs.all %}
                            <tr>
                                <td>{{ log.timestamp|date:"H:i:s, d/m/Y" }}</td>
                                <td>{{ log.latitude|floatformat:5 }}</td>
                                <td>{{ log.longitude|floatformat:5 }}</td>
                                <td><a href="https://www.google.com/maps?q={{ log.latitude }},{{ log.longitude }}" target="_blank">Xem</a></td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <p class="info-text italic no-logs-msg" style="display: none;">Chưa có lượt click nào.</p>
                {% else %}
                <div class="logs-table-wrapper" style="display: none;">
                     <table class="logs-table">
                        <thead>
                            <tr>
                                <th>Thời gian</th>
                                <th>Vĩ độ</th>
                                <th>Kinh độ</th>
                                <th>Bản đồ</th>
                            </tr>
                        </thead>
                        <tbody id="log-table-body-{{ link.id }}"></tbody>
                    </table>
                </div>
                <p class="info-text italic no-logs-msg">Chưa có lượt click nào.</p>
                {% endif %}
            </div>
            {% empty %}
            <p id="no-links-msg" class="info-text text-center">Chưa có link nào được tạo.</p>
            {% endfor %}
        </div>
    </div>
</div>
<footer class="site-footer"> <p>Copyright © 2025 Lequyphat</p> </footer>
{% endblock %}

{% block extra_js %}
<script>
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    function copyToClipboard(elementId) {
        // SỬA LỖI: Lấy nội dung text từ thẻ SPAN bên trong
        const textToCopy = document.getElementById(elementId).querySelector('span').innerText;
        
        // Sử dụng API Clipboard hiện đại và an toàn hơn
        navigator.clipboard.writeText(textToCopy).then(function() {
            alert('Đã sao chép link!');
        }, function(err) {
            console.error('Không thể sao chép: ', err);
            alert('Lỗi: Không thể sao chép link.');
        });
    }

    async function deleteTrackingLink(linkId) {
        if (!confirm('Bạn có chắc chắn muốn xóa link theo dõi này không? Mọi dữ liệu nhật ký liên quan cũng sẽ bị xóa vĩnh viễn.')) {
            return;
        }

        try {
            const response = await fetch(`/api/location-tracker/delete/${linkId}/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                }
            });
            const data = await response.json();
            if (response.ok && data.status === 'success') {
                document.getElementById(`history-item-${linkId}`).remove();
                alert(data.message);
            } else {
                alert(data.error || 'Đã có lỗi xảy ra.');
            }
        } catch (error) {
            console.error('Lỗi khi xóa link:', error);
            alert('Không thể kết nối đến máy chủ.');
        }
    }

    function updateDashboard(linksData) {
        linksData.forEach(link => {
            const historyItem = document.getElementById(`history-item-${link.id}`);
            if (!historyItem) return;

            const logCountEl = historyItem.querySelector('.log-count');
            if (logCountEl) {
                logCountEl.innerText = link.log_count;
            }

            const tableBody = historyItem.querySelector(`#log-table-body-${link.id}`);
            const tableWrapper = historyItem.querySelector('.logs-table-wrapper');
            const noLogsMsg = historyItem.querySelector('.no-logs-msg');

            if (tableBody) {
                let newTbodyContent = '';
                link.logs.forEach(log => {
                    const latDisplay = typeof log.latitude === 'number' ? log.latitude.toFixed(5) : 'N/A';
                    const lonDisplay = typeof log.longitude === 'number' ? log.longitude.toFixed(5) : 'N/A';
                    
                    newTbodyContent += `
                        <tr>
                            <td>${log.timestamp}</td>
                            <td>${latDisplay}</td>
                            <td>${lonDisplay}</td>
                            <td><a href="https://www.google.com/maps?q=${log.latitude},${log.longitude}" target="_blank">Xem</a></td>
                        </tr>
                    `;
                });
                tableBody.innerHTML = newTbodyContent;
            }
            
            if (link.log_count > 0) {
                if (tableWrapper) tableWrapper.style.display = 'block';
                if (noLogsMsg) noLogsMsg.style.display = 'none';
            } else {
                if (tableWrapper) tableWrapper.style.display = 'none';
                if (noLogsMsg) noLogsMsg.style.display = 'block';
            }
        });
    }

    async function fetchTrackerData() {
        try {
            const response = await fetch("{% url 'core:api_get_tracker_data' %}");
            const data = await response.json();
            if (data.links) {
                updateDashboard(data.links);
            }
        } catch (error) {
            console.error("Lỗi khi làm mới dữ liệu:", error);
        }
    }

    // Tự động làm mới mỗi 5 giây
    setInterval(fetchTrackerData, 5000);
</script>
{% endblock %}
