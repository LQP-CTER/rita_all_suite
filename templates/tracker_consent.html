{% load static %}
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yêu cầu Quyền Truy cập</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Space Grotesk', sans-serif;
            background-color: #12121c;
            color: #e0e0e0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            text-align: center;
            padding: 1rem;
            overflow: hidden;
        }
        .bg-effects {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            z-index: -1;
        }
        .glow {
            position: absolute;
            width: 40vw;
            height: 40vw;
            border-radius: 50%;
            filter: blur(150px);
            opacity: 0.2;
        }
        .top-right {
            top: -20vw;
            right: -20vw;
            background: #68d391;
        }
        .bottom-left {
            bottom: -20vw;
            left: -20vw;
            background: #5a67d8;
        }
        .consent-card {
            background: rgba(30, 30, 46, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 2rem 3rem;
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            max-width: 500px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
        }
        h1 {
            font-size: 1.8rem;
            margin-bottom: 1rem;
            color: #fff;
        }
        p {
            font-size: 1rem;
            color: #a0a0d0;
            margin-bottom: 2.5rem;
            line-height: 1.6;
            transition: color 0.3s ease;
        }
        .button-group {
            display: flex;
            gap: 1rem;
            justify-content: center;
        }
        .btn {
            padding: 0.85rem 1.75rem;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1rem;
        }
        .btn-allow {
            background: linear-gradient(90deg, #68d391, #34d399);
            color: #1a1a2e;
        }
        .btn-allow:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(104, 211, 145, 0.3);
        }
        .btn-deny {
            background-color: #3a3a5a;
            color: #e0e0e0;
        }
        .btn-deny:hover {
            background-color: #4a4a6a;
        }
        .loader {
            border: 4px solid #3a3a5a;
            border-top: 4px solid #68d391;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 2rem auto 0;
            display: none;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="bg-effects">
        <div class="glow top-right"></div>
        <div class="glow bottom-left"></div>
    </div>

    <div class="consent-card">
        <h1>Yêu cầu quyền truy cập vị trí</h1>
        <p id="message-p">Để tiếp tục đến trang đích, trang web này cần sự cho phép của bạn để truy cập vị trí hiện tại. Dữ liệu này sẽ được ghi lại một cách ẩn danh.</p>
        <div class="button-group">
            <button id="deny-btn" class="btn btn-deny">Từ chối & Tiếp tục</button>
            <button id="allow-btn" class="btn btn-allow">Cho phép</button>
        </div>
        <div id="loader" class="loader"></div>
    </div>

    <script>
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        const allowBtn = document.getElementById('allow-btn');
        const denyBtn = document.getElementById('deny-btn');
        const loader = document.getElementById('loader');
        const messageParagraph = document.getElementById('message-p');
        const buttonGroup = document.querySelector('.button-group');

        const trackingId = "{{ tracking_link.tracking_id }}";
        const originalUrl = "{{ tracking_link.original_url }}";
        const saveLocationUrl = "{% url 'core:save_location' %}";
        const strictMode = {{ strict_mode|yesno:"true,false" }};

        function showLoader() {
            buttonGroup.style.display = 'none';
            loader.style.display = 'block';
        }

        function redirectToOriginal() {
            window.location.href = originalUrl;
        }
        
        function showErrorMessage() {
            loader.style.display = 'none';
            buttonGroup.style.display = 'none';
            messageParagraph.textContent = 'Bạn phải cho phép truy cập vị trí để có thể tiếp tục. Vui lòng cấp quyền và tải lại trang.';
            messageParagraph.style.color = '#e53e3e'; // Red color for error
        }

        denyBtn.addEventListener('click', () => {
            if (strictMode) {
                showErrorMessage();
            } else {
                redirectToOriginal();
            }
        });

        allowBtn.addEventListener('click', () => {
            showLoader();
            if (!navigator.geolocation) {
                if (strictMode) showErrorMessage();
                else redirectToOriginal();
                return;
            }

            navigator.geolocation.getCurrentPosition(
                // Success callback
                (position) => {
                    const { latitude, longitude } = position.coords;
                    
                    fetch(saveLocationUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCookie('csrftoken')
                        },
                        body: JSON.stringify({
                            tracking_id: trackingId,
                            latitude: latitude,
                            longitude: longitude
                        })
                    }).finally(() => {
                        redirectToOriginal();
                    });
                },
                // Error callback
                () => {
                    if (strictMode) {
                        showErrorMessage();
                    } else {
                        redirectToOriginal();
                    }
                }
            );
        });
    </script>
</body>
</html>
