{% extends 'base.html' %}
{% load static %}

{% block title %}Rita Chat Studio{% endblock %}

{% block extra_css %}
    <style>
        body {
            /* Cho phép trang cuộn khi nội dung dài hơn màn hình */
            overflow-y: auto;
        }
        .app-container {
            /* Đảm bảo container chính có chiều cao tối thiểu bằng màn hình */
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            padding: 1.5rem;
        }
        .main-content {
            padding: 0;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            flex: 1; /* Cho phép phần nội dung chính co giãn */
            min-height: 0; /* Quan trọng để flexbox co giãn đúng cách */
        }

        /* Styles for the new header card */
        .tool-hero {
            display: flex;
            gap: 2.5rem;
            align-items: center; /* Changed to center for better alignment */
            padding: 2rem 2.4rem;
            border-radius: 28px;
            background: linear-gradient(145deg, rgba(26, 26, 46, 0.95), rgba(12, 14, 24, 0.92));
            border: 1px solid rgba(255, 255, 255, 0.08);
            position: relative;
            overflow: hidden;
            box-shadow: 0 30px 80px rgba(5, 8, 20, 0.55);
        }
        .tool-hero::after {
            content: "";
            position: absolute;
            inset: 0;
            background: radial-gradient(circle at top right, rgba(79, 209, 197, 0.3), transparent 55%),
                        radial-gradient(circle at bottom left, rgba(104, 211, 145, 0.18), transparent 60%);
            pointer-events: none;
        }
        .hero-copy {
            position: relative;
            z-index: 1;
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        .hero-eyebrow {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.35rem 0.9rem;
            border-radius: 999px;
            background: rgba(104, 211, 145, 0.12);
            color: var(--primary-color);
            font-size: 0.85rem;
            letter-spacing: 0.04em;
            text-transform: uppercase;
            width: fit-content;
        }
        .hero-copy h1 {
            font-size: 2rem;
            font-weight: 600;
            line-height: 1.2;
            color: var(--text-primary);
            margin: 0;
        }
        .hero-copy p {
            color: var(--text-secondary);
            max-width: 600px;
            line-height: 1.7;
            font-size: 0.95rem;
            margin: 0;
        }
        /* New styles for hero graphic */
        .hero-graphic {
            position: relative;
            z-index: 1;
            width: 150px; /* Increased size */
            height: 120px;
            opacity: 0.7; /* Increased opacity */
        }
        
        .chat-shell {
            display: grid;
            grid-template-columns: minmax(260px, 300px) minmax(0, 1fr);
            gap: 1.5rem;
            flex: 1;
            min-height: 0;
        }
        .chat-sidebar {
            display: flex;
            flex-direction: column;
            gap: 1.25rem;
            min-height: 0;
        }
        .sidebar-card {
            position: relative;
            border-radius: 22px;
            padding: 1.35rem 1.5rem;
            background: linear-gradient(135deg, rgba(26, 26, 46, 0.95), rgba(12, 14, 24, 0.9));
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 20px 45px rgba(5, 8, 20, 0.38);
        }
        .sidebar-card h3 {
            margin: 0 0 1rem;
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
        }
        .sidebar-card p {
            font-size: 0.9rem;
            color: var(--text-secondary);
            line-height: 1.6;
            margin: 0;
        }
        .sidebar-actions {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 1rem;
            margin-bottom: 1.25rem;
        }
        .action-btn {
            display: flex;
            align-items: center;
            gap: 0.65rem;
            padding: 0.6rem 1rem;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
            font-size: 0.9rem;
            cursor: pointer;
            transition: var(--transition-smooth);
        }
        .action-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.15);
        }
        .search-toggle-wrapper {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 1rem;
            padding: 0.75rem;
            border-radius: 14px;
            background: rgba(12, 14, 24, 0.7);
        }
        .search-toggle-wrapper label {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }
        .switch {
            position: relative;
            display: inline-block;
            width: 44px;
            height: 24px;
        }
        .switch input { display: none; }
        .slider {
            position: absolute;
            cursor: pointer;
            inset: 0;
            background-color: rgba(255, 255, 255, 0.1);
            transition: .3s;
            border-radius: 24px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .3s;
            border-radius: 50%;
        }
        input:checked + .slider {
            background: linear-gradient(135deg, #68d391, #4fd1c5);
        }
        input:checked + .slider:before {
            transform: translateX(19px);
        }
        .prompt-chips {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        .prompt-chip {
            padding: 0.8rem 1rem;
            background: rgba(255, 255, 255, 0.04);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 14px;
            color: var(--text-secondary);
            font-size: 0.9rem;
            cursor: pointer;
            transition: var(--transition-smooth);
            text-align: left;
        }
        .prompt-chip:hover {
            background: rgba(255, 255, 255, 0.08);
            color: var(--text-primary);
        }
        .chat-interface {
            display: flex;
            flex-direction: column;
            min-height: 0;
            background: linear-gradient(145deg, rgba(26, 26, 46, 0.9), rgba(12, 14, 24, 0.85));
            border-radius: 22px;
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 28px 60px rgba(5, 8, 20, 0.4);
        }
        .chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 1.75rem;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }
        .chat-container::-webkit-scrollbar { width: 8px; }
        .chat-container::-webkit-scrollbar-track { background: transparent; }
        .chat-container::-webkit-scrollbar-thumb { background-color: rgba(255,255,255,0.1); border-radius: 4px; }
        .chat-container::-webkit-scrollbar-thumb:hover { background-color: rgba(104, 211, 145, 0.3); }

        .message {
            display: flex;
            max-width: 80%;
            align-items: flex-start;
            gap: 1rem;
            animation: messageFadeIn 0.3s ease-out;
        }
        @keyframes messageFadeIn { from { opacity: 0; transform: translateY(12px); } to { opacity: 1; transform: translateY(0); } }

        .message.user {
            align-self: flex-end;
            flex-direction: row-reverse;
        }
        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: var(--surface-color);
            border: 1px solid rgba(255,255,255,0.1);
        }
        .message-avatar img { width: 100%; height: 100%; object-fit: cover; border-radius: 50%; }
        .message-content {
            padding: 0.85rem 1.25rem;
            border-radius: 18px;
            line-height: 1.65;
            background-color: var(--surface-color);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
        }
        .message-content.thinking {
            color: var(--text-secondary);
        }
        .user .message-content {
            background: linear-gradient(135deg, #68d391, #4fd1c5);
            color: #0b0c12;
            border: none;
        }
        /* Styles for chat placeholder */
        .chat-placeholder {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            color: var(--text-secondary);
            padding: 2rem;
            opacity: 0.6;
        }
        .placeholder-logo {
            width: 72px;
            height: 72px;
            margin-bottom: 1.5rem;
        }
        .chat-placeholder h2 {
            font-size: 1.5rem;
            margin: 0 0 0.5rem;
            color: var(--text-primary);
        }
        .chat-placeholder p {
            margin: 0;
        }

        .chat-input-area {
            padding: 1.25rem 1.75rem;
            border-top: 1px solid rgba(255, 255, 255, 0.08);
            background: rgba(12, 14, 24, 0.5);
            border-radius: 0 0 22px 22px;
            backdrop-filter: blur(8px);
        }
        #file-info-container {
            display: none;
            flex-wrap: wrap;
            gap: 0.65rem;
            margin-bottom: 0.85rem;
        }
        .file-info-item {
            display: inline-flex;
            align-items: center;
            gap: 0.6rem;
            background-color: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            padding: 0.4rem 0.8rem;
            border-radius: 10px;
            font-size: 0.8rem;
        }
        .remove-file-btn {
            cursor: pointer;
            font-size: 1.1rem;
            color: var(--text-secondary);
            border: none;
            background: none;
            padding: 0;
        }
        .chat-input-form {
            display: flex;
            align-items: flex-end;
            gap: 0.75rem;
            background-color: var(--surface-color);
            padding: 0.5rem;
            border-radius: 16px;
            border: 1px solid var(--border-color);
            transition: var(--transition-smooth);
        }
        .chat-input-form:focus-within {
            border-color: var(--primary-color);
        }
        #message-input {
            flex-grow: 1;
            background: none;
            color: var(--text-primary);
            border: none;
            padding: 0.6rem;
            font-size: 1rem;
            resize: none;
            outline: none;
            max-height: 180px;
            overflow-y: auto;
        }
        .icon-btn, #send-btn {
            background: none;
            border: none;
            width: 44px;
            height: 44px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition-smooth);
            color: var(--text-secondary);
            font-size: 1.1rem;
        }
        .icon-btn:hover, #send-btn:hover:not(:disabled) {
            background-color: rgba(255,255,255,0.1);
            color: var(--text-primary);
        }
        #send-btn {
            background-color: var(--primary-color);
            color: #0b0c12;
        }
        #send-btn:disabled {
            background-color: var(--border-color);
            cursor: not-allowed;
            color: var(--text-secondary);
        }
        .input-hints {
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 1rem;
            margin-top: 0.85rem;
            font-size: 0.75rem;
            color: var(--text-secondary);
            opacity: 0.7;
        }
        .input-hints span {
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
        }
        .site-footer {
            text-align: center;
            font-size: 0.75rem;
            color: var(--text-secondary);
            opacity: 0.6;
        }

        @media (max-width: 1200px) {
            .hero-graphic {
                display: none; /* Hide graphic on smaller screens to save space */
            }
        }

        @media (max-width: 900px) {
            .chat-shell { grid-template-columns: 1fr; }
            .chat-sidebar { display: none; } /* Hide sidebar on smaller screens */
        }
    </style>
{% endblock %}

{% block content %}
<section class="tool-hero">
    <div class="hero-copy">
        <span class="hero-eyebrow">
            <span>💬</span>
            Chat Studio
        </span>
        <h1>Trợ lý AI cá nhân của bạn</h1>
        <p>Tương tác với Rita để trò chuyện thông minh, phân tích tệp và nhận thông tin từ web. Bắt đầu bằng cách nhập yêu cầu của bạn bên dưới hoặc chọn một gợi ý nhanh.</p>
    </div>
    <div class="hero-graphic">
        <svg viewBox="0 0 200 120" xmlns="http://www.w3.org/2000/svg">
            <defs>
                <linearGradient id="lineGrad" x1="0%" y1="0%" x2="100%" y2="0%">
                    <stop offset="0%" style="stop-color:#4fd1c5;stop-opacity:0.8" />
                    <stop offset="100%" style="stop-color:#68d391;stop-opacity:0.8" />
                </linearGradient>
                <filter id="glow">
                    <feGaussianBlur stdDeviation="1.5" result="coloredBlur"/>
                    <feMerge>
                        <feMergeNode in="coloredBlur"/>
                        <feMergeNode in="SourceGraphic"/>
                    </feMerge>
                </filter>
            </defs>
            <circle cx="20" cy="60" r="8" fill="url(#lineGrad)" filter="url(#glow)"/>
            <circle cx="70" cy="20" r="6" fill="url(#lineGrad)" />
            <circle cx="70" cy="100" r="6" fill="url(#lineGrad)" />
            <circle cx="130" cy="40" r="7" fill="url(#lineGrad)" />
            <circle cx="130" cy="80" r="7" fill="url(#lineGrad)" />
            <circle cx="180" cy="60" r="8" fill="url(#lineGrad)" filter="url(#glow)"/>
            <line x1="20" y1="60" x2="70" y2="20" stroke="url(#lineGrad)" stroke-width="1.5" opacity="0.5"/>
            <line x1="20" y1="60" x2="70" y2="100" stroke="url(#lineGrad)" stroke-width="1.5" opacity="0.5"/>
            <line x1="70" y1="20" x2="130" y2="40" stroke="url(#lineGrad)" stroke-width="1.5" opacity="0.5"/>
            <line x1="70" y1="20" x2="130" y2="80" stroke="url(#lineGrad)" stroke-width="1.5" opacity="0.5"/>
            <line x1="70" y1="100" x2="130" y2="40" stroke="url(#lineGrad)" stroke-width="1.5" opacity="0.5"/>
            <line x1="70" y1="100" x2="130" y2="80" stroke="url(#lineGrad)" stroke-width="1.5" opacity="0.5"/>
            <line x1="130" y1="40" x2="180" y2="60" stroke="url(#lineGrad)" stroke-width="1.5" opacity="0.5"/>
            <line x1="130" y1="80" x2="180" y2="60" stroke="url(#lineGrad)" stroke-width="1.5" opacity="0.5"/>
        </svg>
    </div>
</section>

<div class="chat-shell">
    <aside class="chat-sidebar">
        <div class="sidebar-card">
            <div class="sidebar-actions">
                <button id="refresh-btn" class="action-btn">
                    <i class="fas fa-sync-alt"></i> Trò chuyện mới
                </button>
            </div>
            <div class="search-toggle-wrapper">
                <label for="search-web-toggle">Tìm kiếm web</label>
                <label class="switch">
                    <input type="checkbox" id="search-web-toggle" name="search_web">
                    <span class="slider"></span>
                </label>
            </div>
        </div>
        <div class="sidebar-card">
            <h3>Gợi ý nhanh</h3>
            <div class="prompt-chips">
                <button class="prompt-chip" data-prompt="Giải thích về điện toán lượng tử một cách đơn giản">Giải thích về điện toán lượng tử</button>
                <button class="prompt-chip" data-prompt="Đề xuất một vài ý tưởng sáng tạo cho sinh nhật của một đứa trẻ 10 tuổi">Ý tưởng cho tiệc sinh nhật</button>
                <button class="prompt-chip" data-prompt="Viết một script Python để sắp xếp danh sách các dictionary theo một key cụ thể">Script Python để sắp xếp</button>
            </div>
        </div>
        <div class="sidebar-card">
            <h3>Bạn có biết?</h3>
            <p>Bạn có thể tải lên tối đa 5 tệp (mỗi tệp không quá 10MB), bao gồm hình ảnh, tệp văn bản và PDF. Rita sẽ phân tích nội dung để đưa ra câu trả lời chính xác hơn.</p>
        </div>
    </aside>

    <section class="chat-interface">
        <div id="chat-container" class="chat-container">
            {% if not chat_history %}
            <div class="chat-placeholder" id="chat-placeholder">
                <img src="https://res.cloudinary.com/dd7gti2kn/image/upload/v1752353858/Rita_logo__gjytjk.png" alt="Rita Logo" class="placeholder-logo">
                <h2>Tôi có thể giúp gì cho bạn hôm nay?</h2>
                <p>Bắt đầu cuộc trò chuyện mới hoặc thử một gợi ý nhanh.</p>
            </div>
            {% endif %}
            {% for message in chat_history %}
                <div class="message {% if message.role == 'user' %}user{% else %}rita{% endif %}">
                    <div class="message-avatar">
                        {% if message.role == 'user' %}
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="#e0e0e0" viewBox="0 0 16 16"><path d="M8 8a3 3 0 1 0 0-6 3 3 0 0 0 0 6m2-3a2 2 0 1 1-4 0 2 2 0 0 1 4 0m4 8c0 1-1 1-1 1H3s-1 0-1-1 1-4 6-4 6 3 6 4m-1-.004c-.001-.246-.154-.986-.832-1.664C11.516 10.68 10.289 10 8 10s-3.516.68-4.168 1.332c-.678.678-.83 1.418-.832 1.664z"/></svg>
                        {% else %}
                            <img src="https://res.cloudinary.com/dd7gti2kn/image/upload/v1752353858/Rita_logo__gjytjk.png" alt="Rita">
                        {% endif %}
                    </div>
                    <div class="message-content">
                        <p>{{ message.content|safe|linebreaksbr }}</p>
                    </div>
                </div>
            {% endfor %}
        </div>

        <div class="chat-input-area">
            <div id="file-info-container"></div>
            <form id="chat-form" class="chat-input-form" enctype="multipart/form-data">
                {% csrf_token %}
                <button type="button" class="icon-btn" id="upload-btn" title="Đính kèm tệp">
                    <i class="fas fa-paperclip"></i>
                </button>
                <textarea name="message" id="message-input" placeholder="Nhập yêu cầu của bạn..." rows="1"></textarea>
                <button type="submit" id="send-btn" title="Gửi" disabled>
                    <i class="fas fa-paper-plane"></i>
                </button>
                <input type="file" id="file-input" multiple hidden>
            </form>
            <div class="input-hints">
                <span><code>Shift</code> + <code>Enter</code> để xuống dòng</span>
                <span><i class="fas fa-bolt"></i> Nhấn gợi ý để tự động điền</span>
                <span><i class="fas fa-shield-check"></i> Tệp của bạn được bảo mật</span>
            </div>
        </div>
    </section>
</div>

<footer class="site-footer">
    <p>Rita có thể mắc lỗi - hãy kiểm tra lại các thông tin quan trọng. © 2025 Lequyphat</p>
</footer>
{% endblock %}

{% block extra_js %}
    <script src="{% static 'js/main.js' %}"></script>
{% endblock %}